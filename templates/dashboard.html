{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h2 class="fw-bold text-primary">Dashboard Analisis</h2>
        <p class="text-muted">Ikhtisar aset kendaraan dan rekomendasi lelang.</p>
    </div>
    <div class="col-md-4 text-end">
        <a href="{{ url_for('main.retrain') }}" class="btn btn-outline-primary btn-sm"><i
                class="fa-solid fa-sync me-1"></i> Retrain AI</a>
        <a href="{{ url_for('main.analyze_all') }}" class="btn btn-primary btn-sm"><i
                class="fa-solid fa-magic me-1"></i> Jalankan Analisis</a>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-md-4">
        <div class="stat-card">
            <a href="{{ url_for('main.vehicles') }}" class="text-decoration-none">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="text-muted mb-2">
                            <i class="fa-solid fa-car me-2"></i>Total Kendaraan
                        </h6>
                        <h3 class="mb-0">{{ total }}</h3>
                    </div>
                    <div class="text-end">
                        <i class="fa-solid fa-arrow-right text-gradient" style="font-size: 1.5rem;"></i>
                    </div>
                </div>
            </a>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stat-card">
            <a href="{{ url_for('main.auction_list') }}" class="text-decoration-none">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="text-muted mb-2">
                            <i class="fa-solid fa-gavel me-2"></i>Layak Lelang
                        </h6>
                        <!-- FIXED: Color matched to Pie Chart (#2563eb) -->
                        <h3 class="mb-0" style="color: #2563eb !important;">{{ layak }}</h3>
                    </div>
                    <div class="text-end">
                        <i class="fa-solid fa-arrow-right text-gradient" style="font-size: 1.5rem;"></i>
                    </div>
                </div>
            </a>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stat-card">
            <a href="{{ url_for('main.damaged_vehicles') }}" class="text-decoration-none">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="text-muted mb-2">
                            <i class="fa-solid fa-wrench me-2"></i>Kendaraan Rusak
                        </h6>
                        <h3 class="mb-0 text-warning">{{ damaged }}</h3>
                    </div>
                    <div class="text-end">
                        <i class="fa-solid fa-arrow-right text-gradient" style="font-size: 1.5rem;"></i>
                    </div>
                </div>
            </a>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6 mb-3">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white fw-bold">Status Kelayakan Aset</div>
            <div class="card-body">
                <div style="height: 300px; position: relative;">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-3">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white fw-bold">Distribusi Kondisi Kendaraan</div>
            <div class="card-body">
                <div style="height: 300px; position: relative;">
                    <canvas id="conditionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm border-0 bg-light">
            <div class="card-body py-2 d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2"
                        style="width: 32px; height: 32px; font-size: 0.8rem;">
                        <i class="fa-solid fa-robot"></i>
                    </div>
                    <span class="fw-bold text-dark small">Performa AI</span>
                </div>

                <div class="d-flex align-items-center gap-3">
                    {% if ml_metrics %}
                    {% for model, scores in ml_metrics.items() %}
                    <div class="d-flex align-items-center gap-2 small">
                        <span class="fw-bold text-primary">{{ model }}</span>
                        <div class="vr opacity-50"></div>
                        <span class="text-muted">R2: <strong class="text-dark">{{ "%.1f"|format(scores.R2 *
                                100) }}%</strong></span>
                        <div class="vr opacity-50"></div>
                        <span class="text-muted">MAE: <strong class="text-dark">Rp {{
                                "{:,.0f}".format(scores.MAE).replace(',', '.') }}</strong></span>
                    </div>
                    {% endfor %}
                    {% else %}
                    <span class="text-muted fst-italic small"><i class="fa-solid fa-circle-exclamation me-1"></i>Model
                        belum
                        dilatih</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Access computed styles to match charts with theme
    // We stick to solid hex codes that work on both white and slate backgrounds for now

    // Status Chart (Doughnut)
    const ctx1 = document.getElementById('statusChart').getContext('2d');
    new Chart(ctx1, {
        type: 'doughnut',
        data: {
            labels: ['Layak Lelang', 'Tidak Layak'],
            datasets: [{
                data: {{ status_data }},
        // Royal Blue (#2563eb) vs Slate Grey
        backgroundColor: ['#2563eb', '#94a3b8'],
        borderWidth: 0,
        hoverOffset: 4
    }]
        },
        options: {
        maintainAspectRatio: false,
        cutout: '70%',
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    usePointStyle: true,
                    padding: 20
                }
            }
        }
    }
    });

    // Condition Chart (Bar)
    const ctx2 = document.getElementById('conditionChart').getContext('2d');
    new Chart(ctx2, {
        type: 'bar',
        data: {
            labels: ['Baik', 'Rusak Ringan', 'Rusak Berat'],
            datasets: [{
                label: 'Jumlah Kendaraan',
                data: {{ condition_data }},
        // Emerald (Good), Amber (Warning), Red (Danger) - Universal Semantics
        backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
        borderRadius: 4,
        barThickness: 40
    }]
        },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    display: true,
                    drawBorder: false,
                    color: 'rgba(0,0,0,0.05)' // Gentle grid
                },
                ticks: { stepSize: 1 }
            },
            x: {
                grid: { display: false }
            }
        }
    }
    });
</script>
{% endblock %}